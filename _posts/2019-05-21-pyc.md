---
title: HANDCRAFTED PYC(HITCON-2016)
date: 2019-05-21 15:25:53
tags: [Record,Reverse]
categories: 
            - record
            - reverse
---
HW结束之后有些自闭，做了HITCON2016的一个逆向，第一次遇到记录一下。

运行：

python load进去查看更多的信息

```
>>> import base64,zlib,marsahl
>>> a = marshal.loads(zlib.decompress(base64.b64decode('eJyNVktv00AQXm/eL0igiaFA01IO4cIVCUGFBBJwqRAckLhEIQmtRfPwI0QIeio/hRO/hJ/CiStH2M/prj07diGRP43Hs9+MZ2fWMxbnP6mux+oK9xVMHPFViLdCTB0xkeKDFEFfTIU4E8KZq8dCvB4UlN3hGEsdddXU9QTLv1eFiGKGM4cKUgsFCNLFH7dFrS9poayFYmIZm1b0gyqxMOwJaU3r6\
... xs9sW1ooakXuRv+un7Q0sIlLVzOCZq/XtsK2oTSYaZlStogXi1HV0iazoN2CV2HZeXqRQ54TlJRb7FUlKyUatISsdzo+P7UU1Gb1POdMruckepGwk9tIXQTftz2yBaT5JQovWvpSa6poJPuqgao+b9l5Aj/R+mLQIP4f6Q8Vb3g/5TB/TJxWGdZr9EQrmn99fwKtTvAZGU7wzS7GNpZpDm2JgCrr8wrmPoo54UqGampFIeS9ojXjc4E2yI06bq/4DRoUAc0nVnng4k6p7\
... Ks0+j/S8z9V+NZ5dhmrJUM/y7JTJeRtnJ2TSYJvsFq3CQt/vnfqmQXt5KlpuRcIvDAmhnn2E0t9BJ3SvB/SfLWhuOWNiNVZ+h28g4wlwUp00w95si43rZ3r6+fUIEdgOZbQAsyFRRvBR6dla8KCzRdslar7WS+a5HFb39peIAmG7uZTHVm17Czxju4m6bayz8e7J40DzqM0jr0bmv9PmPvk6y5z57HU8wdTDHeiUJvBMAM4+0CpoAZ4BPgJeAYEAHmgAUgAHiAj4AVAGO\
... Rtwd4AVgC3gEmgBBwCPgMWANOAQ8AbwBHgHuAp4D3gLuARwoGmNUizF/j4yDC5BWM1kNvvlxFA8xikRrBxHIUhutFMBlgQoshhPphGAXe/OggKqqb2cibxwuEXjUcQjccxi5eFRL1fDSbKrUhy2CMb2aLyepkegDWsBwPlrVC0/kLHmeCBQ==')))
>>> dir(a)
['__class__', '__cmp__', '__delattr__', '__doc__', '__eq__', '__format__', '__ge__', '__getattribute__', '__gt__', '__hash__', '__init__', '__le__', '__lt__', '__ne__', '__new__', '__reduce__', '__reduce_ex__', '__repr__', '__setattr__', '__sizeof__', '__str__', '__subclasshook__', 'co_argcount', 'co_cellvars', 'co_code', 'co_consts', 'co_filename', 'co_firstlineno', 'co_flags', 'co_freevars', 'co_lnotab', 'co_name', 'co_names', 'co_nlocals', 'co_stacksize', 'co_varnames']
>>> type(a)
<type 'code'>
>>> a.co_consts[1]
<code object main at 0x7fb3a733e030, file "<string>", line 1>
>>> a.co_consts
(None, <code object main at 0x7fb3a733e030, file "<string>", line 1>, '__main__')
>>> a.co_consts[1].co_code
't\x00\x00d\x01\x00\x83\x01\x00t\x00\x00d\x01\x00\x83\x01\x00t\x00\x00d\x02\x00\x83\x01\x00t\x00\x00d\x03\x00\x83\x01\x00\x02\x17\x02\x17\x02\x17t\x00\x00d\x04\x00\x83\x01\x00t\x00\x00d\x05\x00\x83\x01\x00t\x00\x00d\x06\x00\x83\x01\x00t\x00\x00d\x04\x00\x83\x01\x00\x02\x17\x02\x17\x02\x17\x17t\x00\x00d\x07\x00\x83\x01\x00t\x00\x00d\x08\x00\x83\x01\x00t\x00\x00d\x04\x00\x83\x01\x00t\x00\x00d\x02\x00\x83\x01\x00\x02\x17\x02\x17\x02\x17t\x00\x00d\t\x00\x83\x01\x00t\x00\x00d\n\x00\x83\x01\x00\x02\x17t\x00\x00d\x04\x00\x83\x01\x00t\x00\x00d\x0b\x00\x83\x01\x00t\x00\x00d\x0c\x00\x83\x01\x00\x02\x17\x02\x17\x17\x17\x17t\x00\x00d\n\x00\x83\x01\x00t\x00\x00d\r\x00\x83\x01\x00t\x00\x00d\x0e\x00\x83\x01\x00t\x00\x00d\x0f\x00\x83\x01\x00\x02\x17\x02\x17\x02\x17t\x00\x00d\x04\x00\x83\x01\x00t\x00\x00d\x01\x00\x83\x01\x00t\x00\x00d\x02\x00\x83\x01\x00t\x00\x00d\x10\x00\x83\x01\x00\x02\x17\x02\x17\x02\x17\x17t\x00\x00d\t\x00\x83\x01\x00t\x00\x00d\x11\x00\x83\x01\x00t\x00\x00d\x02\x00\x83\x01\x00t\x00\x00d\x06\x00\x83\x01\x00\x02\x17\x02\x17\x02\x17t\x00\x00d\x0b\x00\x83\x01\x00t\x00\x00d\x0e\x00\x83\x01\x00\x02\x17t\x00\x00d\x04\x00\x83\x01\x00t\x00\x00d\x12\x00\x83\x01\x00t\x00\x00d\x05\x00\x83\x01\x00\x02\x17\x02\x17\x17\x17\x17\x17t\x00\x00d\x02\x00\x83\x01\x00t\x00\x00d\x11\x00\x83\x01\x00t\x00\x00d\x04\x00\x83\x01\x00t\x00\x00d\x13\x00\x83\x01\x00\x02\x17\x02\x17\x02\x17t\x00\x00d\x0b\x00\x83\x01\x00t\x00\x00d\x0e\x00\x83\x01\x00t\x00\x00d\x04\x00\x83\x01\x00t\x00\x00d\x0b\x00\x83\x01\x00\x02\x17\x02\x17\x02\x17\x17t\x00\x00d\x14\x00\x83\x01\x00t\x00\x00d\r\x00\x83\x01\x00t\x00\x00d\x05\x00\x83\x01\x00t\x00\x00d\n\x00\x83\x01\x00\x02\x17\x02\x17\x02\x17t\x00\x00d\x05\x00\x83\x01\x00t\x00\x00d\r\x00\x83\x01\x00\x02\x17t\x00\x00d\x08\x00\x83\x01\x00t\x00\x00d\x04\x00\x83\x01\x00t\x00\x00d\n\x00\x83\x01\x00\x02\x17\x02\x17\x17\x17\x17t\x00\x00d\x0c\x00\x83\x01\x00t\x00\x00d\t\x00\x83\x01\x00t\x00\x00d\n\x00\x83\x01\x00t\x00\x00d\x07\x00\x83\x01\x00\x02\x17\x02\x17\x02\x17t\x00\x00d\x04\x00\x83\x01\x00t\x00\x00d\x0b\x00\x83\x01\x00\x02\x17t\x00\x00d\n\x00\x83\x01\x00t\x00\x00d\x07\x00\x83\x01\x00t\x00\x00d\x15\x00\x83\x01\x00\x02\x17\x02\x17\x17\x17t\x00\x00d\x16\x00\x83\x01\x00t\x00\x00d\x0c\x00\x83\x01\x00t\x00\x00d\x11\x00\x83\x01\x00t\x00\x00d\x05\x00\x83\x01\x00\x02\x17\x02\x17\x02\x17t\x00\x00d\x17\x00\x83\x01\x00t\x00\x00d\x05\x00\x83\x01\x00\x02\x17t\x00\x00d\x12\x00\x83\x01\x00t\x00\x00d\x12\x00\x83\x01\x00t\x00\x00d\x12\x00\x83\x01\x00\x02\x17\x02\x17\x17\x17\x17\x17\x17d\x00\x00\tq\xf7\x02t\x01\x00q\xc8\x05|\x00\x00k\x02\x00q\xff\x02\x02}\x00\x00\x01q\xe8\x02r7\x06t\x00\x00d\x11\x00\x83\x01\x00t\x00\x00d\n\x00\x83\x01\x00t\x00\x00d\x0e\x00\x83\x01\x00t\x00\x00d\t\x00\x83\x01\x00\x02\x17\x02\x17\x02\x17t\x00\x00d\x18\x00\x83\x01\x00t\x00\x00d\x19\x00\x83\x01\x00t\x00\x00d\x0b\x00\x83\x01\x00t\x00\x00d\x0c\x00\x83\x01\x00\x02\x17\x02\x17\x02\x17\x17t\x00\x00d\x07\x00\x83\x01\x00t\x00\x00d\x04\x00\x83\x01\x00t\x00\x00d\x1a\x00\x83\x01\x00t\x00\x00d\x0c\x00\x83\x01\x00\x02\x17\x02\x17\x02\x17t\x00\x00d\x11\x00\x83\x01\x00t\x00\x00d\x04\x00\x83\x01\x00t\x00\x00d\x10\x00\x83\x01\x00t\x00\x00d\x0c\x00\x83\x01\x00\x02\x17\x02\x17\x02\x17\x17\x17t\x00\x00d\x11\x00\x83\x01\x00t\x00\x00d\x04\x00\x83\x01\x00t\x00\x00d\x0b\x00\x83\x01\x00t\x00\x00d\x02\x00\x83\x01\x00\x02\x17\x02\x17\x02\x17t\x00\x00d\x0e\x00\x83\x01\x00t\x00\x00d\x14\x00\x83\x01\x00t\x00\x00d\x06\x00\x83\x01\x00t\x00\x00d\x0c\x00\x83\x01\x00\x02\x17\x02\x17\x02\x17\x17t\x00\x00d\x02\x00\x83\x01\x00t\x00\x00d\x04\x00\x83\x01\x00t\x00\x00d\x05\x00\x83\x01\x00t\x00\x00d\x01\x00\x83\x01\x00\x02\x17\x02\x17\x02\x17t\x00\x00d\x16\x00\x83\x01\x00t\x00\x00d\x0b\x00\x83\x01\x00\x02\x17t\x00\x00d\x10\x00\x83\x01\x00t\x00\x00d\r\x00\x83\x01\x00t\x00\x00d\x04\x00\x83\x01\x00\x02\x17\x02\x17\x17\x17\x17\x17t\x00\x00d\x07\x00\x83\x01\x00t\x00\x00d\x08\x00\x83\x01\x00t\x00\x00d\x04\x00\x83\x01\x00t\x00\x00d\x0b\x00\x83\x01\x00\x02\x17\x02\x17\x02\x17t\x00\x00d\x0b\x00\x83\x01\x00t\x00\x00d\x0c\x00\x83\x01\x00t\x00\x00d\t\x00\x83\x01\x00t\x00\x00d\n\x00\x83\x01\x00\x02\x17\x02\x17\x02\x17\x17t\x00\x00d\n\x00\x83\x01\x00t\x00\x00d\x07\x00\x83\x01\x00t\x00\x00d\x15\x00\x83\x01\x00t\x00\x00d\x04\x00\x83\x01\x00\x02\x17\x02\x17\x02\x17t\x00\x00d\x16\x00\x83\x01\x00t\x00\x00d\x0c\x00\x83\x01\x00t\x00\x00d\x11\x00\x83\x01\x00t\x00\x00d\x05\x00\x83\x01\x00\x02\x17\x02\x17\x02\x17\x17\x17t\x00\x00d\x0b\x00\x83\x01\x00t\x00\x00d\x0e\x00\x83\x01\x00t\x00\x00d\x04\x00\x83\x01\x00t\x00\x00d\x05\x00\x83\x01\x00\x02\x17\x02\x17\x02\x17t\x00\x00d\x10\x00\x83\x01\x00t\x00\x00d\x0c\x00\x83\x01\x00t\x00\x00d\x07\x00\x83\x01\x00t\x00\x00d\x04\x00\x83\x01\x00\x02\x17\x02\x17\x02\x17\x17t\x00\x00d\r\x00\x83\x01\x00t\x00\x00d\x15\x00\x83\x01\x00t\x00\x00d\x04\x00\x83\x01\x00t\x00\x00d\r\x00\x83\x01\x00\x02\x17\x02\x17\x02\x17t\x00\x00d\x0e\x00\x83\x01\x00t\x00\x00d\x02\x00\x83\x01\x00\x02\x17t\x00\x00d\x1b\x00\x83\x01\x00t\x00\x00d\x12\x00\x83\x01\x00t\x00\x00d\x0b\x00\x83\x01\x00\x02\x17\x02\x17\x17\x17\x17\x17\x17q\xa4\x08t\x00\x00d\x02\x00\x83\x01\x00t\x00\x00d\x14\x00\x83\x01\x00\x02\x17t\x00\x00d\x1a\x00\x83\x01\x00t\x00\x00d\x17\x00\x83\x01\x00t\x00\x00d\x17\x00\x83\x01\x00\x02\x17\x02\x17\x17t\x00\x00d\r\x00\x83\x01\x00t\x00\x00d\x0c\x00\x83\x01\x00\x02\x17t\x00\x00d\x04\x00\x83\x01\x00t\x00\x00d\x1c\x00\x83\x01\x00t\x00\x00d\x16\x00\x83\x01\x00\x02\x17\x02\x17\x17\x17\x83\x01\x00q\xee\x02t\x00\x00d\x0c\x00\x83\x01\x00t\x00\x00d\r\x00\x83\x01\x00t\x00\x00d\x1d\x00\x83\x01\x00\x02\x17\x02\x17t\x00\x00d\x14\x00\x83\x01\x00t\x00\x00d\x04\x00\x83\x01\x00t\x00\x00d\x1e\x00\x83\x01\x00t\x00\x00d\x0b\x00\x83\x01\x00\x02\x17\x02\x17\x02\x17\x17t\x00\x00d\x17\x00\x83\x01\x00t\x00\x00d\x17\x00\x83\x01\x00t\x00\x00d\x02\x00\x83\x01\x00\x02\x17\x02\x17t\x00\x00d\x16\x00\x83\x01\x00t\x00\x00d\r\x00\x83\x01\x00t\x00\x00d\x0c\x00\x83\x01\x00t\x00\x00d\x1a\x00\x83\x01\x00\x02\x17\x02\x17\x02\x17\x17\x17t\x00\x00d\x1f\x00\x83\x01\x00t\x00\x00d\x1f\x00\x83\x01\x00t\x00\x00d\x1f\x00\x83\x01\x00\x02\x17\x02\x17t\x00\x00d\x05\x00\x83\x01\x00t\x00\x00d\x01\x00\x83\x01\x00t\x00\x00d\x08\x00\x83\x01\x00t\x00\x00d\x04\x00\x83\x01\x00\x02\x17\x02\x17\x02\x17\x17t\x00\x00d\x04\x00\x83\x01\x00t\x00\x00d\x05\x00\x83\x01\x00t\x00\x00d\x17\x00\x83\x01\x00t\x00\x00d\x02\x00\x83\x01\x00\x02\x17\x02\x17\x02\x17t\x00\x00d\x04\x00\x83\x01\x00t\x00\x00d\x07\x00\x83\x01\x00t\x00\x00d\r\x00\x83\x01\x00t\x00\x00d\n\x00\x83\x01\x00\x02\x17\x02\x17\x02\x17\x17\x17\x17t\x00\x00d\x02\x00\x83\x01\x00t\x00\x00d\x1e\x00\x83\x01\x00t\x00\x00d\x02\x00\x83\x01\x00\x02\x17\x02\x17t\x00\x00d\x04\x00\x83\x01\x00t\x00\x00d\x1f\x00\x83\x01\x00t\x00\x00d\x0b\x00\x83\x01\x00t\x00\x00d\x0e\x00\x83\x01\x00\x02\x17\x02\x17\x02\x17\x17t\x00\x00d\x04\x00\x83\x01\x00t\x00\x00d\x0c\x00\x83\x01\x00t\x00\x00d \x00\x83\x01\x00\x02\x17\x02\x17t\x00\x00d\x04\x00\x83\x01\x00t\x00\x00d\n\x00\x83\x01\x00t\x00\x00d\x0c\x00\x83\x01\x00t\x00\x00d\x0b\x00\x83\x01\x00\x02\x17\x02\x17\x02\x17\x17\x17t\x00\x00d\x10\x00\x83\x01\x00t\x00\x00d\r\x00\x83\x01\x00t\x00\x00d\x15\x00\x83\x01\x00\x02\x17\x02\x17t\x00\x00d!\x00\x83\x01\x00t\x00\x00d\x04\x00\x83\x01\x00t\x00\x00d\x05\x00\x83\x01\x00t\x00\x00d\n\x00\x83\x01\x00\x02\x17\x02\x17\x02\x17\x17t\x00\x00d\x05\x00\x83\x01\x00t\x00\x00d\x11\x00\x83\x01\x00t\x00\x00d\r\x00\x83\x01\x00t\x00\x00d\x0c\x00\x83\x01\x00\x02\x17\x02\x17\x02\x17t\x00\x00d"\x00\x83\x01\x00t\x00\x00d#\x00\x83\x01\x00t\x00\x00d\x04\x00\x83\x01\x00t\x00\x00d\x1f\x00\x83\x01\x00\x02\x17\x02\x17\x02\x17\x17\x17\x17\x17GHd\x00\x00S'
>>> a.co_consts[1].co_names
('chr', 'raw_input')
```

可以看到代码有两部分，在主函数中有chr(),raw_input()函数被调用。用dis库转化成python的字节码 dis.disassemble_string(a.co_consts[1].co_code) 

代码中的LOAD_FAST可能是之前的password，参考opcode.h修改指令。

```
#!/usr/bin/env python

# -*- coding: utf-8 -*-
 
import marshal, zlib, base64
import dis
 
a = marshal.loads(zlib.decompress(base64.b64decode('eJyNVktv00AQXm/eL0igiaFA01IO4cIVCUGFBBJwqRAckLhEIQmtRfPwI0QIeio/hRO/hJ/CiStH2M/prj07diGRP43Hs9+MZ2fWMxbnP6mux+oK9xVMHPFViLdCTB0xkeKDFEFfTIU4E8KZq8dCvB4UlN3hGEsdddXU9QTLv1eFiGKGM4cKUgsFCNLFH7dFrS9poayFYmIZm1b0gyqxMOwJaU3r6xs9sW1ooakXuRv+un7Q0sIlLVzOCZq/XtsK2oTSYaZlStogXi1HV0iazoN2CV2HZeXqRQ54TlJRb7FUlKyUatISsdzo+P7UU1Gb1POdMruckepGwk9tIXQTftz2yBaT5JQovWvpSa6poJPuqgao+b9l5Aj/R+mLQIP4f6Q8Vb3g/5TB/TJxWGdZr9EQrmn99fwKtTvAZGU7wzS7GNpZpDm2JgCrr8wrmPoo54UqGampFIeS9ojXjc4E2yI06bq/4DRoUAc0nVnng4k6p7Ks0+j/S8z9V+NZ5dhmrJUM/y7JTJeRtnJ2TSYJvsFq3CQt/vnfqmQXt5KlpuRcIvDAmhnn2E0t9BJ3SvB/SfLWhuOWNiNVZ+h28g4wlwUp00w95si43rZ3r6+fUIEdgOZbQAsyFRRvBR6dla8KCzRdslar7WS+a5HFb39peIAmG7uZTHVm17Czxju4m6bayz8e7J40DzqM0jr0bmv9PmPvk6y5z57HU8wdTDHeiUJvBMAM4+0CpoAZ4BPgJeAYEAHmgAUgAHiAj4AVAGORtwd4AVgC3gEmgBBwCPgMWANOAQ8AbwBHgHuAp4D3gLuARwoGmNUizF/j4yDC5BWM1kNvvlxFA8xikRrBxHIUhutFMBlgQoshhPphGAXe/OggKqqb2cibxwuEXjUcQjccxi5eFRL1fDSbKrUhy2CMb2aLyepkegDWsBwPlrVC0/kLHmeCBQ==')))
 
b = a.co_consts[1]
code = b.co_code[:-6] + "|\x00\x00" + b.co_code[2212:]
c = b.__class__(b.co_argcount, b.co_nlocals, b.co_stacksize, b.co_flags, code, b.co_consts, b.co_names, b.co_varnames, b.co_filename, b.co_name, b.co_firstlineno, b.co_lnotab, b.co_freevars, b.co_cellvars)
 
exec(c)
```
修改之后运行可以得到password，输入password可以得到flag。


另一种解法
referance: https://hackerstan.com/hitcon-2016-reverse-50-handcrafted-pyc-6e3e7425ea43